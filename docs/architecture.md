# 架构设计文档

## 概述

@ldesign/form v2.0 采用全新的分层架构设计，将表单的核心业务逻辑完全抽离为框架无关的纯 TypeScript 模块，通过适配器模式为不同 UI 框架提供统一的底层能力。

## 架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    UI 框架层                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │    Vue 3    │  │   React     │  │  Angular    │          │
│  │ Components  │  │ Components  │  │ Components  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                    适配器层                                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │    Vue      │  │   React     │  │  Angular    │          │
│  │  Adapter    │  │  Adapter    │  │  Adapter    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐                          │
│  │  Vanilla    │  │    Base     │                          │
│  │  Adapter    │  │  Adapter    │                          │
│  └─────────────┘  └─────────────┘                          │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                 核心逻辑层（框架无关）                          │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │ Form Core   │  │ Validation  │  │   Field     │          │
│  │   Engine    │  │   Engine    │  │  Manager    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │    Data     │  │    State    │  │    Event    │          │
│  │  Manager    │  │  Manager    │  │   System    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. FormCore（表单核心引擎）

**职责：**
- 协调各个子系统的工作
- 提供统一的表单操作接口
- 管理表单生命周期

**主要功能：**
- 表单实例创建和销毁
- 数据操作（获取、设置、重置）
- 验证协调
- 事件分发

### 2. DataManager（数据管理器）

**职责：**
- 管理表单数据的存储和变更
- 支持深层路径访问
- 提供数据快照和恢复功能

**主要功能：**
- 数据的获取和设置
- 深层路径操作（如 'user.profile.name'）
- 数据变化监听
- 快照管理

### 3. StateManager（状态管理器）

**职责：**
- 管理表单和字段的状态信息
- 跟踪验证状态、提交状态等

**主要功能：**
- 表单状态管理（valid、submitting、validating等）
- 字段状态管理（touched、dirty、errors等）
- 状态变化通知

### 4. ValidationEngine（验证引擎）

**职责：**
- 执行表单和字段验证
- 管理验证规则和验证器
- 支持同步和异步验证

**主要功能：**
- 验证器注册和管理
- 单字段验证
- 整表单验证
- 验证缓存
- 条件验证

### 5. FieldManager（字段管理器）

**职责：**
- 管理表单字段的配置和状态
- 处理字段依赖关系
- 支持字段联动

**主要功能：**
- 字段注册和注销
- 字段配置管理
- 依赖关系处理
- 字段可见性和禁用状态

### 6. EventEmitter（事件系统）

**职责：**
- 提供事件发布订阅机制
- 支持各模块间的解耦通信

**主要功能：**
- 事件监听器管理
- 事件触发和分发
- 一次性事件监听
- 事件清理

## 适配器系统

### BaseAdapter（基础适配器）

定义了所有适配器必须实现的基础接口：

```typescript
abstract class BaseAdapter {
  abstract isSupported(): boolean
  abstract render(form: FormCore, options?: RenderOptions): any
  abstract mount(form: FormCore, container: HTMLElement | string, options?: RenderOptions): void
  abstract unmount(): void
}
```

### VanillaAdapter（原生适配器）

为原生JavaScript环境提供表单渲染功能：

- 直接操作DOM元素
- 处理表单事件绑定
- 管理表单样式和状态显示
- 支持字段渲染器扩展

### 框架特定适配器

每个框架都有对应的适配器实现：

- **VueAdapter**: 集成Vue 3的响应式系统
- **ReactAdapter**: 支持React的组件生命周期
- **AngularAdapter**: 集成Angular的依赖注入系统

## 设计原则

### 1. 单一职责原则

每个模块都有明确的职责边界，避免功能重叠。

### 2. 开放封闭原则

核心功能对扩展开放，对修改封闭。通过插件和适配器支持扩展。

### 3. 依赖倒置原则

高层模块不依赖低层模块，都依赖于抽象接口。

### 4. 接口隔离原则

提供细粒度的接口，避免强制实现不需要的功能。

## 数据流

```
用户操作 → 适配器 → FormCore → 相应的Manager → 状态更新 → 事件通知 → 适配器 → UI更新
```

### 典型的数据流示例：

1. **用户输入**：用户在输入框中输入内容
2. **事件捕获**：适配器捕获DOM事件
3. **数据更新**：调用FormCore.setFieldValue()
4. **数据处理**：DataManager更新数据并触发change事件
5. **状态更新**：StateManager更新字段状态
6. **验证触发**：如果启用了onChange验证，ValidationEngine执行验证
7. **结果通知**：通过事件系统通知相关模块
8. **UI更新**：适配器接收通知并更新UI显示

## 扩展机制

### 1. 自定义验证器

```typescript
validationEngine.registerValidator('custom', ({ value, rule }) => {
  // 自定义验证逻辑
  return {
    valid: /* 验证结果 */,
    message: /* 错误消息 */
  }
})
```

### 2. 自定义字段渲染器

```typescript
adapter.registerFieldRenderer({
  type: 'custom-input',
  render: (config, value, onChange) => {
    // 自定义字段渲染逻辑
    return customElement
  }
})
```

### 3. 插件系统

```typescript
const plugin = {
  install(formCore) {
    // 插件安装逻辑
  }
}

formCore.use(plugin)
```

## 性能优化

### 1. 智能缓存

- 验证结果缓存
- 数据快照缓存
- 渲染结果缓存

### 2. 事件优化

- 事件防抖和节流
- 批量状态更新
- 异步验证队列

### 3. 内存管理

- 自动清理事件监听器
- 及时销毁不需要的实例
- 弱引用避免内存泄漏

## 类型安全

整个架构都基于TypeScript构建，提供：

- 完整的类型定义
- 泛型支持
- 类型推导
- 编译时类型检查

这确保了在开发过程中的类型安全，减少运行时错误。
